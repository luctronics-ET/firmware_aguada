<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aguada V2 - Leituras do Node</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; margin: 0; background: #f5f6fa; }
    .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
    .card { background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 20px; margin-bottom: 16px; }
    .title { color: #2d3559; margin: 0 0 6px; }
    .muted { color: #6b7280; font-size: 14px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { text-align: left; padding: 10px; border-bottom: 1px solid #e5e7eb; font-size: 14px; }
    thead th { background: #f9fafb; font-weight: 600; color: #374151; }
    .toolbar { display: flex; gap: 12px; align-items: center; justify-content: space-between; margin-top: 8px; }
    .btn { background: #4f46e5; color: #fff; border: 0; padding: 8px 14px; border-radius: 6px; cursor: pointer; text-decoration: none; display: inline-block; }
    .btn:disabled { opacity: 0.6; cursor: default; }
    .btn.success { background: #10b981; }
    .btn.warning { background: #f59e0b; }
    .back { text-decoration: none; color: #4f46e5; font-weight: 600; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .pill.good { background: #dcfce7; color: #166534; }
    .pill.warn { background: #fef9c3; color: #854d0e; }
    .pill.bad { background: #fee2e2; color: #991b1b; }
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; }
    .stat-value { font-size: 24px; font-weight: bold; color: #1f2937; }
    .stat-label { font-size: 12px; color: #6b7280; margin-top: 4px; }
  </style>
</head>
<body>
  {% include '_shared_nav.html' %}
  
  <div class="container">
    <div class="card">
      <h1 class="title">üìü Leituras do Node: <span id="nodeId">{{ node_id }}</span></h1>
      <div class="muted">Hist√≥rico recente de leituras recebidas pelo backend</div>
      
      <div class="stats-row" id="nodeStats">
        <div class="stat-card">
          <div class="stat-value" id="totalReadings">-</div>
          <div class="stat-label">Total Leituras</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="currentVolume">-</div>
          <div class="stat-label">Volume Atual (L)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="currentLevel">-</div>
          <div class="stat-label">N√≠vel (%)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="lastRSSI">-</div>
          <div class="stat-label">RSSI (dBm)</div>
        </div>
      </div>
      
      <div class="toolbar">
        <div>
          <label for="limit">Quantidade:</label>
          <select id="limit">
            <option>25</option>
            <option selected>50</option>
            <option>100</option>
            <option>200</option>
          </select>
        </div>
        <div>
          <button id="refresh" class="btn">üîÑ Atualizar</button>
          <a id="cfg" href="/node-config/{{ node_id }}" class="btn success">‚öôÔ∏è Configurar</a>
          <a href="/consumo-detalhado?node={{ node_id }}" class="btn warning">üìâ Consumo</a>
          <a href="/" class="back">‚Üê Voltar ao dashboard</a>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Timestamp</th>
            <th>MAC</th>
            <th>Dist√¢ncia (cm)</th>
            <th>Bateria (mV)</th>
            <th>RSSI (dBm)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="7">Carregando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const nodeId = document.getElementById('nodeId').textContent;
  const rows = document.getElementById('rows');
    const limitSel = document.getElementById('limit');
    const btn = document.getElementById('refresh');
  const cfg = document.getElementById('cfg');
  cfg.href = `/node-config/${encodeURIComponent(nodeId)}`;

    function formatTS(ts) {
      if (!ts) return '-';
      const d = new Date(ts);
      return d.toLocaleString('pt-BR');
    }

    function statusPill(ts) {
      if (!ts) return '<span class="pill bad">offline</span>';
      const now = Date.now();
      const t = new Date(ts).getTime();
      const diffMin = (now - t) / 60000;
      if (diffMin < 2) return '<span class="pill good">online</span>';
      if (diffMin < 10) return '<span class="pill warn">recent</span>';
      return '<span class="pill bad">offline</span>';
    }

    async function load() {
      try {
        rows.innerHTML = '<tr><td colspan="7">Carregando...</td></tr>';
        const limit = parseInt(limitSel.value, 10) || 50;
        const resp = await fetch(`/api/readings/${encodeURIComponent(nodeId)}?limit=${limit}`);
        
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        
        // Atualizar estat√≠sticas
        updateStats(data);
        
        if (data.length === 0) {
          rows.innerHTML = '<tr><td colspan="7">Nenhuma leitura encontrada</td></tr>';
          return;
        }

        rows.innerHTML = data.map((row, i) => `
          <tr onclick="showReadingDetails(${JSON.stringify(row).replace(/"/g, '&quot;')})">
            <td>${i + 1}</td>
            <td>${formatTS(row.timestamp)}</td>
            <td><code>${row.mac_address || '-'}</code></td>
            <td>${row.distance_cm !== null ? row.distance_cm.toFixed(1) : '-'}</td>
            <td>${row.battery_mv || '-'}</td>
            <td>${row.rssi || '-'}</td>
            <td>${statusPill(row.timestamp)}</td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Erro:', error);
        rows.innerHTML = `<tr><td colspan="7">‚ùå Erro: ${error.message}</td></tr>`;
      }
    }
    
    function updateStats(readings) {
      const total = readings.length;
      const latest = readings[0];
      
      document.getElementById('totalReadings').textContent = total;
      document.getElementById('currentVolume').textContent = latest?.volume_liters ? 
        Math.round(latest.volume_liters).toLocaleString('pt-BR') : '-';
      document.getElementById('currentLevel').textContent = latest?.percentage ? 
        latest.percentage.toFixed(1) + '%' : '-';
      document.getElementById('lastRSSI').textContent = latest?.rssi || '-';
    }
    
    function showReadingDetails(reading) {
      const details = `
        üìä Detalhes da Leitura
        
        Timestamp: ${formatTS(reading.timestamp)}
        Dist√¢ncia: ${reading.distance_cm !== null ? reading.distance_cm.toFixed(2) + ' cm' : 'N/A'}
        Volume: ${reading.volume_liters !== null ? Math.round(reading.volume_liters).toLocaleString('pt-BR') + ' L' : 'N/A'}
        Percentual: ${reading.percentage !== null ? reading.percentage.toFixed(1) + '%' : 'N/A'}
        Bateria: ${reading.battery_mv || 'N/A'} mV
        RSSI: ${reading.rssi || 'N/A'} dBm
        MAC: ${reading.mac_address || 'N/A'}
      `;
      
      alert(details);
    }
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        
        // Atualizar estat√≠sticas
        updateStats(data);
        
        if (data.length === 0) {
          rows.innerHTML = '<tr><td colspan="7">Nenhuma leitura encontrada</td></tr>';
          return;
        }

        rows.innerHTML = data.map((row, i) => `
          <tr onclick="showReadingDetails(${JSON.stringify(row).replace(/"/g, '&quot;')})">
            <td>${i + 1}</td>
            <td>${formatTS(row.timestamp)}</td>
            <td><code>${row.mac_address || '-'}</code></td>
            <td>${row.distance_cm !== null ? row.distance_cm.toFixed(1) : '-'}</td>
            <td>${row.battery_mv || '-'}</td>
            <td>${row.rssi || '-'}</td>
            <td>${statusPill(row.timestamp)}</td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Erro:', error);
        rows.innerHTML = `<tr><td colspan="7">‚ùå Erro: ${error.message}</td></tr>`;
      }
    }
    
    function updateStats(readings) {
      const total = readings.length;
      const latest = readings[0];
      
      document.getElementById('totalReadings').textContent = total;
      document.getElementById('currentVolume').textContent = latest?.volume_liters ? 
        Math.round(latest.volume_liters).toLocaleString('pt-BR') : '-';
      document.getElementById('currentLevel').textContent = latest?.percentage ? 
        latest.percentage.toFixed(1) + '%' : '-';
      document.getElementById('lastRSSI').textContent = latest?.rssi || '-';
    }
    
    function showReadingDetails(reading) {
      const details = `
        üìä Detalhes da Leitura
        
        Timestamp: ${formatTS(reading.timestamp)}
        Dist√¢ncia: ${reading.distance_cm !== null ? reading.distance_cm.toFixed(2) + ' cm' : 'N/A'}
        Volume: ${reading.volume_liters !== null ? Math.round(reading.volume_liters).toLocaleString('pt-BR') + ' L' : 'N/A'}
        Percentual: ${reading.percentage !== null ? reading.percentage.toFixed(1) + '%' : 'N/A'}
        Bateria: ${reading.battery_mv || 'N/A'} mV
        RSSI: ${reading.rssi || 'N/A'} dBm
        MAC: ${reading.mac_address || 'N/A'}
      `;
      
      alert(details);
    }
    btn.addEventListener('click', load);
    limitSel.addEventListener('change', load);
    load();
  </script>
</body>
</html>
