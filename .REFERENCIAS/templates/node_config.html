<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configura√ß√£o do Node</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; margin: 0; background: #f5f6fa; }
    .container { max-width: 600px; margin: 40px auto; padding: 24px; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    h1 { color: #2d3559; margin-bottom: 18px; }
    label { display: block; margin-top: 16px; color: #374151; font-weight: 500; }
    input[type="text"], input[type="number"] { width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; margin-top: 4px; font-size: 15px; }
    button { margin-top: 24px; background: #4f46e5; color: #fff; border: 0; padding: 10px 18px; border-radius: 6px; font-size: 16px; cursor: pointer; }
    .msg { margin-top: 18px; font-size: 15px; }
    .back { display: inline-block; margin-top: 18px; color: #4f46e5; text-decoration: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Configura√ß√£o do Node <span id="nodeId"></span></h1>
    <form id="configForm">
  <label for="mac">MAC Address <span style="color:#6b7280; font-weight:400">(vem do node, somente leitura)</span></label>
  <input type="text" id="mac" name="mac" readonly placeholder="DC:06:75:67:6A:CC" />
  <label for="area_base_m2">√Årea da base (m¬≤)</label>
  <input type="number" id="area_base_m2" name="area_base_m2" step="0.01" min="0" required />
  <label for="nivel_max_cm">N√≠vel m√°ximo da √°gua (cm)</label>
  <input type="number" id="nivel_max_cm" name="nivel_max_cm" step="1" min="0" required />
  <label for="offset_cm">Offset do sensor (cm)</label>
  <input type="number" id="offset_cm" name="offset_cm" step="1" min="0" required />
  <label for="nome">Nome do reservat√≥rio</label>
  <input type="text" id="nome" name="nome" maxlength="100" />
  <label for="local">Local do reservat√≥rio</label>
  <input type="text" id="local" name="local" maxlength="100" />
  <label for="tipo">Tipo do reservat√≥rio</label>
  <input type="text" id="tipo" name="tipo" maxlength="50" />
  <label for="alias">C√≥digo/Alias do reservat√≥rio</label>
  <input type="text" id="alias" name="alias" maxlength="50" />
  
  <hr style="margin: 32px 0; border: none; border-top: 1px solid #e5e7eb;" />
  
  <h2 style="color: #2d3559; margin-top: 24px; margin-bottom: 16px;">‚è±Ô∏è Intervalos de Leitura e Polling</h2>
  
  <label for="read_interval_sec">Intervalo de Leitura (segundos) <span style="color:#6b7280; font-weight:400">Frequ√™ncia de medi√ß√£o do sensor</span></label>
  <input type="number" id="read_interval_sec" name="read_interval_sec" step="1" min="10" max="3600" placeholder="30" />
  <small style="color: #6b7280; display: block; margin-top: 4px;">Recomendado: CONSUMO=30s, B03=60s, INC√äNDIO=300s, CISTERNAS=600s</small>
  
  <label for="poll_interval_sec">Intervalo de Polling (segundos) <span style="color:#6b7280; font-weight:400">Frequ√™ncia de ping do servidor</span></label>
  <input type="number" id="poll_interval_sec" name="poll_interval_sec" step="1" min="10" max="3600" placeholder="30" />
  <small style="color: #6b7280; display: block; margin-top: 4px;">Recomendado: CONSUMO=30s, B03=120s, INC√äNDIO=600s, CISTERNAS=1800s</small>
  
  <label for="send_interval_sec">Intervalo de Envio (segundos) <span style="color:#6b7280; font-weight:400">Frequ√™ncia de envio de dados (se mudan√ßa significativa)</span></label>
  <input type="number" id="send_interval_sec" name="send_interval_sec" step="1" min="10" max="3600" placeholder="60" />
  <small style="color: #6b7280; display: block; margin-top: 4px;">Recomendado: CONSUMO=30s, B03=60s, INC√äNDIO=300s, CISTERNAS=600s</small>
  
  <hr style="margin: 32px 0; border: none; border-top: 1px solid #e5e7eb;" />
  
  <h2 style="color: #2d3559; margin-top: 24px; margin-bottom: 16px;">üìä Filtros de Mudan√ßa</h2>
  
  <label for="threshold_cm">Threshold de Mudan√ßa (cm) <span style="color:#6b7280; font-weight:400">Mudan√ßa m√≠nima para considerar significativa</span></label>
  <input type="number" id="threshold_cm" name="threshold_cm" step="0.1" min="0.1" max="100" placeholder="2.0" />
  <small style="color: #6b7280; display: block; margin-top: 4px;">Recomendado: CONSUMO=1.0cm, B03=2.0cm, INC√äNDIO=5.0cm, CISTERNAS=10.0cm</small>
  
  <label for="time_sustained_sec">Tempo M√≠nimo Continuado (segundos) <span style="color:#6b7280; font-weight:400">Tempo que a mudan√ßa deve se manter para ser enviada</span></label>
  <input type="number" id="time_sustained_sec" name="time_sustained_sec" step="1" min="10" max="3600" placeholder="60" />
  <small style="color: #6b7280; display: block; margin-top: 4px;">Recomendado: CONSUMO=30s, B03=60s, INC√äNDIO=300s, CISTERNAS=600s</small>
  
  <button type="submit">Salvar Configura√ß√£o</button>
    </form>
    <div class="msg" id="msg"></div>
    <a href="/" class="back">‚Üê Voltar ao dashboard</a>
  </div>
  <script>
  const jinjaNodeId = '{{ node_id if node_id != None else "" }}';
  const nodeId = jinjaNodeId && jinjaNodeId !== 'None' ? jinjaNodeId : (new URLSearchParams(window.location.search).get('node_id') || '');
    document.getElementById('nodeId').textContent = nodeId ? `(${nodeId})` : '';
    const form = document.getElementById('configForm');
    const msg = document.getElementById('msg');
    if(nodeId) {
      fetch(`/api/node-config/${encodeURIComponent(nodeId)}`)
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          if(data) {
            form.mac.value = data.mac || '';
            form.area_base_m2.value = data.area_base_m2 || '';
            form.nivel_max_cm.value = data.nivel_max_cm || '';
            form.offset_cm.value = data.offset_cm || '';
            form.nome.value = data.nome || '';
            form.local.value = data.local || '';
            form.tipo.value = data.tipo || '';
            form.alias.value = data.alias || '';
            form.read_interval_sec.value = data.read_interval_sec || '';
            form.poll_interval_sec.value = data.poll_interval_sec || '';
            form.send_interval_sec.value = data.send_interval_sec || '';
            form.threshold_cm.value = data.threshold_cm || '';
            form.time_sustained_sec.value = data.time_sustained_sec || '';
          }
        });
    }
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = 'Salvando...';
      const payload = {
        node_id: nodeId,
        mac: form.mac.value.trim(),
        area_base_m2: parseFloat(form.area_base_m2.value),
        nivel_max_cm: parseInt(form.nivel_max_cm.value),
        offset_cm: parseInt(form.offset_cm.value),
        nome: form.nome.value.trim(),
        local: form.local.value.trim(),
        tipo: form.tipo.value.trim(),
        alias: form.alias.value.trim(),
        read_interval_sec: form.read_interval_sec.value ? parseInt(form.read_interval_sec.value) : null,
        poll_interval_sec: form.poll_interval_sec.value ? parseInt(form.poll_interval_sec.value) : null,
        send_interval_sec: form.send_interval_sec.value ? parseInt(form.send_interval_sec.value) : null,
        threshold_cm: form.threshold_cm.value ? parseFloat(form.threshold_cm.value) : null,
        time_sustained_sec: form.time_sustained_sec.value ? parseInt(form.time_sustained_sec.value) : null
      };
      const resp = await fetch(`/api/node-config/${encodeURIComponent(nodeId)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if(resp.ok) {
        msg.textContent = 'Configura√ß√£o salva com sucesso!';
      } else {
        msg.textContent = 'Erro ao salvar configura√ß√£o.';
      }
    });
  </script>
</body>
</html>
