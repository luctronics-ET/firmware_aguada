<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCADA - CMASM AGUADA</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="assets/css/variables.css">
  <link rel="stylesheet" href="assets/css/animations.css">
  
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #1a1a2e;
      color: #ffffff;
    }
    
    /* SCADA Dark Theme */
    .scada-panel {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .scada-widget {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .scada-widget:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(59, 130, 246, 0.5);
      transform: translateY(-2px);
    }
    
    /* Tank visualization */
    .tank-container {
      position: relative;
      width: 100%;
      max-width: 200px;
      margin: 0 auto;
    }
    
    .tank-fill {
      transition: height 1s ease;
      border-radius: 8px 8px 0 0;
    }
    
    /* Status indicators */
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
      box-shadow: 0 0 10px currentColor;
      animation: pulse 2s infinite;
    }
    
    .status-ok { background: #22c55e; }
    .status-alert { background: #f59e0b; }
    .status-critical { background: #ef4444; }
    .status-offline { background: #6b7280; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Value display */
    .value-large {
      font-size: 3rem;
      font-weight: 700;
      line-height: 1;
      font-variant-numeric: tabular-nums;
    }
    
    /* Grid lines for technical look */
    .grid-bg {
      background-image: 
        linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
      background-size: 20px 20px;
    }
  </style>
</head>
<body class="bg-gray-900 grid-bg">

  <!-- Include Navigation -->
  <div id="navigation-container"></div>

  <!-- Main Content -->
  <div class="lg:ml-64">
    
    <!-- Include Header -->
    <div id="header-container"></div>

    <!-- SCADA Content -->
    <main class="p-4 sm:p-6 lg:p-8">

      <!-- System Status Bar -->
      <div class="scada-panel rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div class="flex items-center gap-3">
            <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
            <span class="text-lg font-semibold">SISTEMA OPERACIONAL</span>
          </div>
          <div class="flex items-center gap-6 text-sm">
            <div>
              <span class="text-gray-400">Última Atualização:</span>
              <span class="text-white font-mono ml-2" id="last-update">--:--:--</span>
            </div>
            <div>
              <span class="text-gray-400">Taxa Atualização:</span>
              <span class="text-white font-mono ml-2">10s</span>
            </div>
            <button onclick="toggleFullscreen()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded text-white text-sm transition-colors">
              Tela Cheia
            </button>
          </div>
        </div>
      </div>

      <!-- Main SCADA Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-5 gap-6" id="scada-grid">
        <!-- Sensors will be dynamically loaded -->
      </div>

      <!-- System Overview -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
        
        <!-- Total Volume -->
        <div class="scada-widget rounded-lg p-6">
          <div class="flex items-center justify-between mb-2">
            <span class="text-gray-400 text-sm uppercase">Volume Total</span>
            <span class="status-indicator status-ok"></span>
          </div>
          <div class="value-large text-blue-400" id="total-volume">0</div>
          <div class="text-gray-400 text-sm mt-1">m³ / 170 m³</div>
        </div>

        <!-- Average Level -->
        <div class="scada-widget rounded-lg p-6">
          <div class="flex items-center justify-between mb-2">
            <span class="text-gray-400 text-sm uppercase">Nível Médio</span>
            <span class="status-indicator status-ok"></span>
          </div>
          <div class="value-large text-green-400" id="avg-level">0</div>
          <div class="text-gray-400 text-sm mt-1">%</div>
        </div>

        <!-- Active Alerts -->
        <div class="scada-widget rounded-lg p-6">
          <div class="flex items-center justify-between mb-2">
            <span class="text-gray-400 text-sm uppercase">Alertas Ativos</span>
            <span class="status-indicator" id="alerts-indicator"></span>
          </div>
          <div class="value-large text-red-400" id="active-alerts">0</div>
          <div class="text-gray-400 text-sm mt-1">Notificações</div>
        </div>

      </div>

      <!-- Alarm Log -->
      <div class="scada-widget rounded-lg p-6 mt-6">
        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
          <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          Log de Alarmes
        </h3>
        <div class="space-y-2" id="alarm-log">
          <div class="flex items-center gap-3 text-sm text-gray-400 py-2 border-b border-gray-700">
            <span class="font-mono">--:--:--</span>
            <span>Sistema iniciado</span>
          </div>
        </div>
      </div>

    </main>

  </div>

  <script>
    // Load Components
    fetch('components/navigation.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('navigation-container').innerHTML = html;
      });

    fetch('components/header.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('header-container').innerHTML = html;
      });

    // Sensor Data
    let sensorsData = [
      {
        id: 'RCON',
        name: 'Reservatório Condomínio',
        level: 75,
        volume: 37500,
        capacity: 50000,
        distance_cm: 50,
        status: 'ok',
        lastUpdate: new Date()
      },
      {
        id: 'RCAV',
        name: 'Reservatório Cavalinho',
        level: 45,
        volume: 13500,
        capacity: 30000,
        distance_cm: 110,
        status: 'ok',
        lastUpdate: new Date()
      },
      {
        id: 'RCB3',
        name: 'Reservatório B03',
        level: 18,
        volume: 7200,
        capacity: 40000,
        distance_cm: 164,
        status: 'alert',
        lastUpdate: new Date()
      },
      {
        id: 'CIE1',
        name: 'Captação Ilha Engenho 01',
        level: 85,
        volume: 21250,
        capacity: 25000,
        distance_cm: 30,
        status: 'ok',
        lastUpdate: new Date()
      },
      {
        id: 'CIE2',
        name: 'Captação Ilha Engenho 02',
        level: 70,
        volume: 17500,
        capacity: 25000,
        distance_cm: 60,
        status: 'ok',
        lastUpdate: new Date()
      }
    ];

    // Get level color
    function getLevelColor(level) {
      if (level < 20) return '#ef4444';
      if (level < 40) return '#f59e0b';
      if (level < 60) return '#eab308';
      if (level < 80) return '#22c55e';
      return '#3b82f6';
    }

    // Get status class
    function getStatusClass(status) {
      const classes = {
        'ok': 'status-ok',
        'alert': 'status-alert',
        'critical': 'status-critical',
        'offline': 'status-offline'
      };
      return classes[status] || 'status-offline';
    }

    // Render SCADA widget
    function renderScadaWidget(sensor) {
      const color = getLevelColor(sensor.level);
      const tankHeight = 150;
      const fillHeight = (sensor.level / 100) * tankHeight;

      return `
        <div class="scada-widget rounded-lg p-4 fade-in-up">
          <!-- Header -->
          <div class="flex items-center justify-between mb-3">
            <div>
              <h3 class="font-semibold text-sm">${sensor.id}</h3>
              <p class="text-xs text-gray-400">${sensor.name}</p>
            </div>
            <span class="status-indicator ${getStatusClass(sensor.status)}"></span>
          </div>

          <!-- Tank Visualization -->
          <div class="tank-container mb-3">
            <div class="relative" style="width: 80px; height: ${tankHeight}px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; overflow: hidden; margin: 0 auto;">
              <!-- Fill -->
              <div class="tank-fill absolute bottom-0 left-0 right-0" 
                   style="height: ${fillHeight}px; background: ${color}; opacity: 0.8;"></div>
              <!-- Level text -->
              <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-2xl font-bold" style="text-shadow: 0 2px 4px rgba(0,0,0,0.8);">${sensor.level}%</span>
              </div>
            </div>
          </div>

          <!-- Details -->
          <div class="space-y-2 text-xs">
            <div class="flex justify-between">
              <span class="text-gray-400">Volume:</span>
              <span class="font-mono text-white">${(sensor.volume/1000).toFixed(1)} m³</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Capacidade:</span>
              <span class="font-mono text-white">${(sensor.capacity/1000).toFixed(0)} m³</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Distância:</span>
              <span class="font-mono text-white">${sensor.distance_cm} cm</span>
            </div>
            <div class="flex justify-between border-t border-gray-700 pt-2 mt-2">
              <span class="text-gray-400">Atualizado:</span>
              <span class="font-mono text-gray-300">${sensor.lastUpdate.toLocaleTimeString('pt-BR')}</span>
            </div>
          </div>

          <!-- Action button -->
          <button onclick="viewDetails('${sensor.id}')" 
                  class="w-full mt-3 px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded text-xs font-medium transition-colors">
            Ver Detalhes
          </button>
        </div>
      `;
    }

    // Render all widgets
    function renderScada() {
      const grid = document.getElementById('scada-grid');
      grid.innerHTML = sensorsData.map(renderScadaWidget).join('');
    }

    // Update overview stats
    function updateOverview() {
      const totalVolume = sensorsData.reduce((sum, s) => sum + s.volume, 0);
      const avgLevel = sensorsData.reduce((sum, s) => sum + s.level, 0) / sensorsData.length;
      const alerts = sensorsData.filter(s => s.status === 'alert' || s.status === 'critical').length;

      document.getElementById('total-volume').textContent = (totalVolume / 1000).toFixed(1);
      document.getElementById('avg-level').textContent = avgLevel.toFixed(0);
      document.getElementById('active-alerts').textContent = alerts;

      // Update alerts indicator
      const alertsIndicator = document.getElementById('alerts-indicator');
      if (alerts > 0) {
        alertsIndicator.className = 'status-indicator status-alert';
      } else {
        alertsIndicator.className = 'status-indicator status-ok';
      }

      // Update timestamp
      document.getElementById('last-update').textContent = new Date().toLocaleTimeString('pt-BR');
    }

    // Add alarm to log
    function addAlarm(message, level = 'info') {
      const log = document.getElementById('alarm-log');
      const time = new Date().toLocaleTimeString('pt-BR');
      
      const colors = {
        'info': 'text-blue-400',
        'warning': 'text-yellow-400',
        'critical': 'text-red-400'
      };

      const alarm = document.createElement('div');
      alarm.className = `flex items-center gap-3 text-sm py-2 border-b border-gray-700 ${colors[level]}`;
      alarm.innerHTML = `
        <span class="font-mono">${time}</span>
        <span>${message}</span>
      `;
      
      log.insertBefore(alarm, log.firstChild);

      // Keep only last 10 alarms
      while (log.children.length > 10) {
        log.removeChild(log.lastChild);
      }
    }

    // View details (temporariamente desabilitado - página em desenvolvimento)
    function viewDetails(sensorId) {
      alert(`Detalhes do sensor ${sensorId}\\nEm desenvolvimento...\\n\\nUse a página de Relatórios para ver histórico completo.`);
      // window.location.href = `historico.html?sensor=${sensorId}`;
    }

    // Toggle fullscreen
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    // Poll data
    const POLL_INTERVAL = 10000; // 10 seconds

    function pollData() {
      // Simulate data changes
      sensorsData.forEach(s => {
        const oldLevel = s.level;
        s.level = Math.max(0, Math.min(100, s.level + (Math.random() - 0.5) * 3));
        s.volume = (s.capacity * s.level) / 100;
        s.lastUpdate = new Date();

        // Check for level changes
        if (s.level < 20 && oldLevel >= 20) {
          addAlarm(`${s.id}: Nível crítico atingido (${s.level.toFixed(0)}%)`, 'critical');
          s.status = 'critical';
        } else if (s.level < 40 && oldLevel >= 40) {
          addAlarm(`${s.id}: Nível baixo (${s.level.toFixed(0)}%)`, 'warning');
          s.status = 'alert';
        } else if (s.level >= 40 && s.status !== 'ok') {
          s.status = 'ok';
        }
      });

      renderScada();
      updateOverview();
    }

    // Initialize
    setTimeout(() => {
      renderScada();
      updateOverview();
      addAlarm('Sistema SCADA iniciado', 'info');
      
      // Start polling
      setInterval(pollData, POLL_INTERVAL);
    }, 100);
  </script>

</body>
</html>
